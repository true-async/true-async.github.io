---
layout: interactive
lang: ru
path_key: "/interactive/pdo-pool-demo.html"
nav_active: ""
permalink: /ru/interactive/pdo-pool-demo.html
page_title: "–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—É–ª PDO-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π"
description: "–ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –≤ TrueAsync"
---

<style>
    .interactive-demo .container { max-width: 1400px; margin: 0 auto; }

    .interactive-demo .subtitle {
        text-align: center;
        color: var(--color-text-muted);
        margin-bottom: 16px;
        font-size: 0.95em;
    }

    .interactive-demo .main-layout {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
    }
    @media (max-width: 1000px) {
        .interactive-demo .main-layout { grid-template-columns: 1fr; }
    }

    /* Code panel */
    .interactive-demo .code-panel {
        background: var(--color-code-bg);
        border-radius: var(--radius-xl);
        overflow: hidden;
        border: 2px solid var(--color-border);
        transition: border-color 0.3s;
    }
    .interactive-demo .code-panel.active-c1 { border-color: rgba(37, 99, 235, 0.5); }
    .interactive-demo .code-panel.active-c2 { border-color: rgba(139, 92, 246, 0.5); }
    .interactive-demo .code-panel.active-c3 { border-color: rgba(234, 88, 12, 0.5); }

    .interactive-demo .code-header {
        background: var(--color-bg-subtle);
        padding: 8px 14px;
        font-size: 0.8em;
        font-weight: 600;
        color: var(--color-text-secondary);
        border-bottom: 1px solid var(--color-border);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .interactive-demo .code-content {
        padding: 10px 14px;
        font-family: var(--font-mono);
        font-size: 0.78em;
        line-height: 1.5;
        overflow-x: auto;
    }
    .interactive-demo .code-line {
        padding: 2px 8px;
        border-radius: var(--radius-md);
        transition: background 0.2s;
        white-space: pre;
        color: var(--color-text);
    }
    .interactive-demo .code-line.active-cpu {
        background: rgba(22, 163, 74, 0.12);
        border-left: 3px solid #16A34A;
    }
    .interactive-demo .code-line.active-wait {
        background: rgba(107, 114, 128, 0.1);
        border-left: 3px solid #9CA3AF;
    }
    .interactive-demo .code-line.active-pool-wait {
        background: rgba(234, 88, 12, 0.1);
        border-left: 3px solid #EA580C;
    }
    .interactive-demo .code-line.active-release {
        background: rgba(22, 163, 74, 0.08);
        border-left: 3px solid #16A34A;
    }

    /* Syntax highlighting */
    .interactive-demo .keyword { color: #8250DF; font-weight: 500; }
    .interactive-demo .function { color: #6639BA; }
    .interactive-demo .string { color: #0A3069; }
    .interactive-demo .variable { color: #0550AE; }
    .interactive-demo .comment { color: #6B7280; font-style: italic; }
    .interactive-demo .class { color: #6639BA; font-weight: 600; }
    .interactive-demo .number { color: #0550AE; }

    /* Pool visualisation */
    .interactive-demo .pool-panel {
        background: var(--color-bg-subtle);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-xl);
        padding: 16px 18px;
    }
    .interactive-demo .pool-title {
        font-size: 0.9em;
        font-weight: 700;
        color: var(--color-text-secondary);
        margin-bottom: 12px;
        text-align: center;
    }

    /* Connection slots */
    .interactive-demo .pool-slots {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-bottom: 16px;
    }
    .interactive-demo .pool-slot {
        width: 150px;
        background: var(--color-code-bg);
        border: 2px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: 10px;
        text-align: center;
        transition: all 0.3s;
        position: relative;
    }
    .interactive-demo .pool-slot.in-use-c1 { border-color: #2563EB; background: rgba(37, 99, 235, 0.06); }
    .interactive-demo .pool-slot.in-use-c2 { border-color: #8B5CF6; background: rgba(139, 92, 246, 0.06); }
    .interactive-demo .pool-slot.in-use-c3 { border-color: #EA580C; background: rgba(234, 88, 12, 0.06); }
    .interactive-demo .pool-slot.free { border-color: #16A34A; border-style: dashed; }

    .interactive-demo .slot-icon {
        font-size: 1.5em;
        margin-bottom: 2px;
    }
    .interactive-demo .slot-label {
        font-size: 0.72em;
        font-weight: 600;
        color: var(--color-text-secondary);
    }
    .interactive-demo .slot-user {
        font-size: 0.68em;
        margin-top: 4px;
        padding: 2px 8px;
        border-radius: var(--radius-full);
        display: inline-block;
    }
    .interactive-demo .slot-user.c1 { background: rgba(37, 99, 235, 0.12); color: #2563EB; }
    .interactive-demo .slot-user.c2 { background: rgba(139, 92, 246, 0.12); color: #8B5CF6; }
    .interactive-demo .slot-user.c3 { background: rgba(234, 88, 12, 0.12); color: #EA580C; }
    .interactive-demo .slot-user.free { background: rgba(22, 163, 74, 0.12); color: #16A34A; }

    .interactive-demo .slot-pin {
        font-size: 0.62em;
        margin-top: 3px;
        color: var(--color-text-muted);
        font-style: italic;
    }
    .interactive-demo .slot-pin.stmt { color: #6B58FF; }
    .interactive-demo .slot-pin.txn { color: #DC2626; }

    /* Queue */
    .interactive-demo .pool-queue {
        background: var(--color-code-bg);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: 10px 14px;
        margin-bottom: 14px;
        min-height: 42px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .interactive-demo .queue-label {
        font-size: 0.75em;
        font-weight: 600;
        color: var(--color-text-muted);
        white-space: nowrap;
    }
    .interactive-demo .queue-items {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
    }
    .interactive-demo .queue-item {
        font-size: 0.72em;
        font-weight: 600;
        padding: 3px 10px;
        border-radius: var(--radius-full);
        animation: queuePulse 1.5s infinite;
    }
    .interactive-demo .queue-item.c3 { background: rgba(234, 88, 12, 0.12); color: #EA580C; }
    .interactive-demo .queue-empty {
        font-size: 0.75em;
        color: var(--color-text-muted);
        font-style: italic;
    }

    @keyframes queuePulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Coroutine cards */
    .interactive-demo .coro-cards {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin-bottom: 0;
    }
    @media (max-width: 500px) {
        .interactive-demo .coro-cards { grid-template-columns: 1fr; }
    }
    .interactive-demo .coro-card {
        background: var(--color-code-bg);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: 10px;
        text-align: center;
        transition: all 0.3s;
    }
    .interactive-demo .coro-card.c1 { border-left: 3px solid #2563EB; }
    .interactive-demo .coro-card.c2 { border-left: 3px solid #8B5CF6; }
    .interactive-demo .coro-card.c3 { border-left: 3px solid #EA580C; }
    .interactive-demo .coro-card-name {
        font-size: 0.78em;
        font-weight: 700;
    }
    .interactive-demo .coro-card-name.c1 { color: #2563EB; }
    .interactive-demo .coro-card-name.c2 { color: #8B5CF6; }
    .interactive-demo .coro-card-name.c3 { color: #EA580C; }
    .interactive-demo .coro-card-status {
        font-size: 0.7em;
        margin-top: 3px;
        padding: 2px 8px;
        border-radius: var(--radius-full);
        display: inline-block;
        background: var(--color-bg-subtle);
        color: var(--color-text-muted);
    }
    .interactive-demo .coro-card-status.running { background: rgba(22, 163, 74, 0.12); color: #16A34A; }
    .interactive-demo .coro-card-status.db-wait { background: rgba(107, 88, 255, 0.12); color: #6B58FF; }
    .interactive-demo .coro-card-status.pool-wait { background: rgba(234, 88, 12, 0.12); color: #EA580C; }
    .interactive-demo .coro-card-status.done { background: rgba(22, 163, 74, 0.12); color: #16A34A; }

    /* Timeline panel */
    .interactive-demo .timeline-panel {
        background: var(--color-bg-subtle);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-xl);
        padding: 16px 18px;
    }
    .interactive-demo .timeline-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    .interactive-demo .timeline-title {
        font-size: 1em;
        font-weight: 600;
        color: var(--color-text-secondary);
    }
    .interactive-demo .time-display {
        font-family: var(--font-mono);
        color: var(--color-primary);
        font-size: 1.2em;
        font-weight: 600;
        min-width: 80px;
        text-align: right;
    }

    /* Tracks */
    .interactive-demo .timeline-track { margin-bottom: 8px; }
    .interactive-demo .track-label {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
        gap: 8px;
    }
    .interactive-demo .track-name { font-weight: 600; font-size: 0.8em; min-width: 80px; }
    .interactive-demo .track-name.c1 { color: #2563EB; }
    .interactive-demo .track-name.c2 { color: #8B5CF6; }
    .interactive-demo .track-name.c3 { color: #EA580C; }
    .interactive-demo .track-bar {
        height: 34px;
        background: var(--color-code-bg);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        position: relative;
        overflow: hidden;
    }

    /* Segments */
    .interactive-demo .segment {
        position: absolute; top: 3px; bottom: 3px;
        border-radius: var(--radius-md);
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        font-size: 0.55em; font-weight: 600;
        transition: opacity 0.3s;
        overflow: hidden;
    }
    .interactive-demo .segment-label { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; padding: 0 2px; }
    .interactive-demo .segment-time { font-size: 0.9em; opacity: 0.7; }
    .interactive-demo .segment.cpu {
        background: linear-gradient(135deg, #16A34A, #22C55E);
        color: white;
    }
    .interactive-demo .segment.db-wait {
        background: rgba(107, 88, 255, 0.15);
        color: var(--color-primary);
        border: 1px solid rgba(107, 88, 255, 0.3);
    }
    .interactive-demo .segment.pool-wait {
        background: repeating-linear-gradient(
            -45deg,
            rgba(234, 88, 12, 0.08),
            rgba(234, 88, 12, 0.08) 4px,
            rgba(234, 88, 12, 0.16) 4px,
            rgba(234, 88, 12, 0.16) 8px
        );
        color: #EA580C;
        border: 1px solid rgba(234, 88, 12, 0.3);
    }
    .interactive-demo .segment.future { opacity: 0.25; }

    /* Playhead */
    .interactive-demo .playhead {
        position: absolute; top: 0; bottom: 0; width: 3px;
        background: #DC2626; z-index: 10;
        box-shadow: 0 0 6px rgba(220, 38, 38, 0.4);
    }
    .interactive-demo .playhead::after {
        content: ''; position: absolute; top: -5px; left: -5px;
        width: 13px; height: 13px;
        background: #DC2626; border-radius: 50%;
        box-shadow: 0 0 4px rgba(220, 38, 38, 0.6);
    }

    .interactive-demo .time-scale {
        display: flex; justify-content: space-between;
        padding: 4px 0 0; font-size: 0.7em;
        color: var(--color-text-muted);
    }

    /* Controls */
    .interactive-demo .controls {
        display: flex; justify-content: center; gap: 8px;
        margin-top: 14px; flex-wrap: wrap;
    }
    .interactive-demo .demo-btn {
        padding: 8px 16px; border: none; border-radius: var(--radius-full);
        cursor: pointer; font-size: 0.85em; font-weight: 600;
        font-family: var(--font-sans); transition: all 0.15s;
    }
    .interactive-demo .demo-btn-primary { background: var(--color-primary); color: white; }
    .interactive-demo .demo-btn-primary:hover { background: var(--color-primary-dark); }
    .interactive-demo .demo-btn-secondary {
        background: white; color: var(--color-text);
        box-shadow: 0 1px 3px rgba(0,0,0,0.06), inset 0 0 0 1px rgba(0,0,0,0.08);
    }
    .interactive-demo .demo-btn-secondary:hover { background: var(--color-bg-subtle); }
    .interactive-demo .demo-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    .interactive-demo .speed-control {
        display: flex; align-items: center; gap: 5px;
        background: white; padding: 4px 12px; border-radius: var(--radius-full);
        box-shadow: 0 1px 3px rgba(0,0,0,0.06), inset 0 0 0 1px rgba(0,0,0,0.08);
    }
    .interactive-demo .speed-control label { font-size: 0.8em; color: var(--color-text-muted); font-weight: 500; }
    .interactive-demo .speed-control select {
        background: var(--color-bg-subtle); color: var(--color-text);
        border: 1px solid var(--color-border); padding: 4px 8px;
        border-radius: var(--radius-md); cursor: pointer; font-size: 0.85em;
        font-family: var(--font-sans);
    }
    .interactive-demo .loop-control {
        display: flex; align-items: center;
        background: white; padding: 4px 12px; border-radius: var(--radius-full);
        box-shadow: 0 1px 3px rgba(0,0,0,0.06), inset 0 0 0 1px rgba(0,0,0,0.08);
    }
    .interactive-demo .loop-control label {
        font-size: 0.8em; color: var(--color-text-muted); font-weight: 500;
        cursor: pointer; display: flex; align-items: center; gap: 4px;
    }

    /* Legend */
    .interactive-demo .legend {
        display: flex; justify-content: center; gap: 16px;
        margin-top: 12px; flex-wrap: wrap;
    }
    .interactive-demo .legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.8em; color: var(--color-text-secondary); }
    .interactive-demo .legend-color { width: 14px; height: 14px; border-radius: 3px; }
    .interactive-demo .legend-color.cpu { background: linear-gradient(135deg, #16A34A, #22C55E); }
    .interactive-demo .legend-color.db { background: rgba(107, 88, 255, 0.2); border: 1px solid rgba(107, 88, 255, 0.4); }
    .interactive-demo .legend-color.pool-w {
        background: repeating-linear-gradient(-45deg, rgba(234, 88, 12, 0.1), rgba(234, 88, 12, 0.1) 3px, rgba(234, 88, 12, 0.25) 3px, rgba(234, 88, 12, 0.25) 6px);
        border: 1px solid rgba(234, 88, 12, 0.4);
    }

    /* Stats */
    .interactive-demo .stats {
        display: grid; grid-template-columns: repeat(4, 1fr);
        gap: 8px; margin-top: 12px;
    }
    @media (max-width: 600px) {
        .interactive-demo .stats { grid-template-columns: repeat(2, 1fr); }
    }
    .interactive-demo .stat-card {
        background: white; border: 1px solid var(--color-border);
        padding: 10px; border-radius: var(--radius-lg); text-align: center;
    }
    .interactive-demo .stat-value { font-size: 1.1em; font-weight: 700; color: var(--color-primary); }
    .interactive-demo .stat-value.highlight { color: #16A34A; }
    .interactive-demo .stat-value.warn { color: #EA580C; }
    .interactive-demo .stat-label { font-size: 0.75em; color: var(--color-text-muted); margin-top: 2px; }

    /* Explanation */
    .interactive-demo .explanation {
        background: var(--color-bg-subtle); border: 1px solid var(--color-border);
        border-radius: var(--radius-lg); padding: 14px 18px;
        margin-top: 16px; border-left: 3px solid var(--color-primary);
    }
    .interactive-demo .explanation h3 { color: var(--color-primary); margin-bottom: 6px; font-size: 0.95em; }
    .interactive-demo .explanation p { color: var(--color-text-secondary); font-size: 0.875em; line-height: 1.6; margin: 0; }
    .interactive-demo .explanation p + p { margin-top: 6px; }
    .interactive-demo .explanation .highlight { color: #16A34A; font-weight: 600; }
    .interactive-demo .explanation .db-highlight { color: var(--color-primary); font-weight: 500; }
    .interactive-demo .explanation .pool-highlight { color: #EA580C; font-weight: 600; }
    .interactive-demo .explanation .pin-highlight { color: #DC2626; font-weight: 500; }
    .interactive-demo .explanation code {
        background: var(--color-code-bg); padding: 1px 5px; border-radius: 3px;
        font-size: 0.9em; font-family: var(--font-mono);
    }
</style>

<div class="container">
    <p class="subtitle">3 –∫–æ—Ä—É—Ç–∏–Ω—ã, 2 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ –ø—É–ª–µ ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ $stmt –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</p>

    <div class="main-layout">
        <!-- Left: Code -->
        <div>
            <div class="code-panel" id="codePanel">
                <div class="code-header">
                    <span>–ö–æ–¥ ‚Äî –æ–¥–∏–Ω PDO —Å –ø—É–ª–æ–º, 3 –∫–æ—Ä—É—Ç–∏–Ω—ã</span>
                </div>
                <div class="code-content" id="codeBlock">
                    <div class="code-line" data-line="1"><span class="comment">// –û–¥–∏–Ω PDO-–æ–±—ä–µ–∫—Ç —Å –ø—É–ª–æ–º –Ω–∞ 2 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</span></div>
                    <div class="code-line" data-line="2"><span class="variable">$pdo</span> = <span class="keyword">new</span> <span class="class">PDO</span>(<span class="variable">$dsn</span>, <span class="variable">$user</span>, <span class="variable">$pass</span>, [</div>
                    <div class="code-line" data-line="3">  <span class="class">PDO</span>::<span class="variable">ATTR_POOL_ENABLED</span> => <span class="keyword">true</span>,</div>
                    <div class="code-line" data-line="4">  <span class="class">PDO</span>::<span class="variable">ATTR_POOL_MAX</span>     => <span class="number">2</span>,</div>
                    <div class="code-line" data-line="5">]);</div>
                    <div class="code-line" data-line="6"></div>
                    <div class="code-line" data-line="7"><span class="keyword">for</span> (<span class="variable">$i</span> = <span class="number">1</span>; <span class="variable">$i</span> &lt;= <span class="number">3</span>; <span class="variable">$i</span>++) {</div>
                    <div class="code-line" data-line="8">  <span class="function">spawn</span>(<span class="keyword">function</span>() <span class="keyword">use</span> (<span class="variable">$pdo</span>, <span class="variable">$i</span>) {</div>
                    <div class="code-line" data-line="9">    <span class="comment">// prepare() –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ—Ä—ë—Ç conn –∏–∑ –ø—É–ª–∞</span></div>
                    <div class="code-line" data-line="10">    <span class="variable">$stmt</span> = <span class="variable">$pdo</span>-><span class="function">prepare</span>(<span class="string">"SELECT * FROM users WHERE id=?"</span>);</div>
                    <div class="code-line" data-line="11">    <span class="variable">$stmt</span>-><span class="function">execute</span>([<span class="variable">$i</span>]);  <span class="comment">// –æ–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –ë–î</span></div>
                    <div class="code-line" data-line="12">    <span class="variable">$user</span> = <span class="variable">$stmt</span>-><span class="function">fetch</span>();</div>
                    <div class="code-line" data-line="13"></div>
                    <div class="code-line" data-line="14">    <span class="function">processUser</span>(<span class="variable">$user</span>);</div>
                    <div class="code-line" data-line="15"></div>
                    <div class="code-line" data-line="16">    <span class="comment">// $stmt —É—Ö–æ–¥–∏—Ç –∏–∑ scope -> refcount=0</span></div>
                    <div class="code-line" data-line="17">    <span class="comment">// conn –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—É–ª!</span></div>
                    <div class="code-line" data-line="18">  });</div>
                    <div class="code-line" data-line="19">}</div>
                </div>
            </div>
        </div>

        <!-- Right: Pool visualisation -->
        <div>
            <div class="pool-panel">
                <div class="pool-title">PDO Pool (ATTR_POOL_MAX: 2)</div>

                <div class="pool-slots">
                    <div class="pool-slot free" id="slot0">
                        <div class="slot-icon" id="slotIcon0">üîå</div>
                        <div class="slot-label">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ #1</div>
                        <div class="slot-user free" id="slotUser0">—Å–≤–æ–±–æ–¥–Ω–æ</div>
                        <div class="slot-pin" id="slotPin0"></div>
                    </div>
                    <div class="pool-slot free" id="slot1">
                        <div class="slot-icon" id="slotIcon1">üîå</div>
                        <div class="slot-label">–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ #2</div>
                        <div class="slot-user free" id="slotUser1">—Å–≤–æ–±–æ–¥–Ω–æ</div>
                        <div class="slot-pin" id="slotPin1"></div>
                    </div>
                </div>

                <div class="pool-queue">
                    <span class="queue-label">–û—á–µ—Ä–µ–¥—å –æ–∂–∏–¥–∞–Ω–∏—è:</span>
                    <div class="queue-items" id="queueItems">
                        <span class="queue-empty">–ø—É—Å—Ç–æ</span>
                    </div>
                </div>

                <div class="coro-cards">
                    <div class="coro-card c1">
                        <div class="coro-card-name c1">–ö–æ—Ä—É—Ç–∏–Ω–∞ 1</div>
                        <div class="coro-card-status" id="cardStatus0">–≥–æ—Ç–æ–≤–∞</div>
                    </div>
                    <div class="coro-card c2">
                        <div class="coro-card-name c2">–ö–æ—Ä—É—Ç–∏–Ω–∞ 2</div>
                        <div class="coro-card-status" id="cardStatus1">–≥–æ—Ç–æ–≤–∞</div>
                    </div>
                    <div class="coro-card c3">
                        <div class="coro-card-name c3">–ö–æ—Ä—É—Ç–∏–Ω–∞ 3</div>
                        <div class="coro-card-status" id="cardStatus2">–≥–æ—Ç–æ–≤–∞</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Timeline -->
    <div class="timeline-panel">
        <div class="timeline-header">
            <span class="timeline-title">Timeline –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</span>
            <span class="time-display" id="timeDisplay">0 ms</span>
        </div>

        <div class="timeline-track">
            <div class="track-label"><span class="track-name c1">–ö–æ—Ä—É—Ç–∏–Ω–∞ 1</span></div>
            <div class="track-bar" id="track0"></div>
        </div>
        <div class="timeline-track">
            <div class="track-label"><span class="track-name c2">–ö–æ—Ä—É—Ç–∏–Ω–∞ 2</span></div>
            <div class="track-bar" id="track1"></div>
        </div>
        <div class="timeline-track">
            <div class="track-label"><span class="track-name c3">–ö–æ—Ä—É—Ç–∏–Ω–∞ 3</span></div>
            <div class="track-bar" id="track2"></div>
        </div>

        <div class="time-scale"><span>0</span><span>15</span><span>30</span><span>45</span><span>55ms</span></div>

        <div class="controls">
            <button class="demo-btn demo-btn-primary" id="playBtn">&#9654; –ó–∞–ø—É—Å—Ç–∏—Ç—å</button>
            <button class="demo-btn demo-btn-secondary" id="stepBtn">&#9197; –®–∞–≥</button>
            <button class="demo-btn demo-btn-secondary" id="resetBtn">&#8634; –°–Ω–∞—á–∞–ª–∞</button>
            <div class="speed-control">
                <label>–°–∫–æ—Ä–æ—Å—Ç—å:</label>
                <select id="speedSelect">
                    <option value="800">0.5x</option>
                    <option value="400" selected>1x</option>
                    <option value="200">2x</option>
                    <option value="100">4x</option>
                </select>
            </div>
            <div class="loop-control">
                <label><input type="checkbox" id="loopCheckbox"> –ó–∞—Ü–∏–∫–ª–∏—Ç—å</label>
            </div>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="legend-color cpu"></div><span>CPU —Ä–∞–±–æ—Ç–∞–µ—Ç</span></div>
            <div class="legend-item"><div class="legend-color db"></div><span>–û–∂–∏–¥–∞–Ω–∏–µ –ë–î</span></div>
            <div class="legend-item"><div class="legend-color pool-w"></div><span>–û–∂–∏–¥–∞–Ω–∏–µ –ø—É–ª–∞</span></div>
        </div>

        <div class="stats">
            <div class="stat-card"><div class="stat-value" id="totalTime">0 ms</div><div class="stat-label">–û–±—â–µ–µ –≤—Ä–µ–º—è</div></div>
            <div class="stat-card"><div class="stat-value" id="dbWaitTime">0 ms</div><div class="stat-label">–û–∂–∏–¥–∞–Ω–∏–µ –ë–î</div></div>
            <div class="stat-card"><div class="stat-value warn" id="poolWaitTime">0 ms</div><div class="stat-label">–û–∂–∏–¥–∞–Ω–∏–µ –ø—É–ª–∞</div></div>
            <div class="stat-card"><div class="stat-value highlight" id="savedTime">0 ms</div><div class="stat-label">–°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ</div></div>
        </div>
    </div>

    <div class="explanation">
        <h3 id="explanationTitle">–ù–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å" –¥–ª—è –Ω–∞—á–∞–ª–∞</h3>
        <p id="explanationText">
            –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ <span class="highlight">–ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π PDO</span> –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ä–µ—Å—É—Ä—Å–∞–º–∏.
            –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ <span class="pin-highlight">—É–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è</span>, –ø–æ–∫–∞ –∂–∏–≤ <code>$stmt</code> –∏–ª–∏ –∞–∫—Ç–∏–≤–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è.
            –ö–æ–≥–¥–∞ <code>$stmt</code> —É–Ω–∏—á—Ç–æ–∂–∞–µ—Ç—Å—è –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ—Ç ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ <span class="highlight">–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span> –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—É–ª.
        </p>
    </div>
</div>

<script>
(function() {
    /* ===== SCENARIO =====
     * One PDO object with pool_max=2, shared by 3 coroutines.
     *
     * Key mechanic: connection is PINNED while $stmt exists (refcount>0)
     * or while a transaction is active. When $stmt is destroyed and no txn,
     * connection auto-returns to pool via pdo_pool_maybe_release().
     *
     * C1: prepare(1ms) -> execute/wait(20ms) -> fetch+process(2ms) -> $stmt destroyed -> auto-release
     * C2: prepare(1ms) -> execute/wait(25ms) -> fetch+process(2ms) -> $stmt destroyed -> auto-release
     * C3: pool full, waits -> C1 releases -> prepare(1ms) -> execute/wait(20ms) -> fetch+process(2ms) -> done
     *
     * Timeline (TOTAL_DURATION=55):
     * C1: [0-1 cpu:prepare]  [1-21 db:execute]  [21-23 cpu:fetch+process]  -- $stmt destroyed at 23, conn released
     * C2: [1-2 cpu:prepare]  [2-27 db:execute]  [27-29 cpu:fetch+process]  -- $stmt destroyed at 29, conn released
     * C3: [2-23 pool-wait]   [23-24 cpu:prepare] [24-44 db:execute] [44-46 cpu:fetch+process]
     *
     * Sequential: 3 * (1+20+2) = 69ms
     * With pool: 46ms -> saved 23ms (~33%)
     */
    var TOTAL_DURATION = 55;

    var timelines = [
        [ // C1
            { start: 0,  duration: 1,  type: 'cpu',       label: 'prepare' },
            { start: 1,  duration: 20, type: 'db-wait',   label: 'execute' },
            { start: 21, duration: 2,  type: 'cpu',       label: 'fetch+process' }
        ],
        [ // C2
            { start: 1,  duration: 1,  type: 'cpu',       label: 'prepare' },
            { start: 2,  duration: 25, type: 'db-wait',   label: 'execute' },
            { start: 27, duration: 2,  type: 'cpu',       label: 'fetch+process' }
        ],
        [ // C3
            { start: 2,  duration: 21, type: 'pool-wait', label: '–∂–¥—ë—Ç –ø—É–ª' },
            { start: 23, duration: 1,  type: 'cpu',       label: 'prepare' },
            { start: 24, duration: 20, type: 'db-wait',   label: 'execute' },
            { start: 44, duration: 2,  type: 'cpu',       label: 'fetch+process' }
        ]
    ];

    var steps = [
        {
            time: 0,
            title: '–°—Ç–∞—Ä—Ç',
            text: '<p>–°–æ–∑–¥–∞–Ω <code>PDO</code> —Å <code>ATTR_POOL_ENABLED => true</code> –∏ <code>ATTR_POOL_MAX => 2</code>. –¢—Ä–∏ –∫–æ—Ä—É—Ç–∏–Ω—ã –∑–∞–ø—É—â–µ–Ω—ã —á–µ—Ä–µ–∑ <span class="highlight">spawn()</span>.</p>' +
                  '<p>–ü—É–ª –ø–æ–∫–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π ‚Äî –æ–Ω–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –ª–µ–Ω–∏–≤–æ, –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ.</p>',
            line: '2', lineState: 'cpu',
            slots: ['free', 'free'], slotPins: ['', ''], queue: [],
            cards: ['–≥–æ—Ç–æ–≤–∞', '–≥–æ—Ç–æ–≤–∞', '–≥–æ—Ç–æ–≤–∞'], cardStates: ['', '', '']
        },
        {
            time: 0.5,
            title: '–ö–æ—Ä—É—Ç–∏–Ω–∞ 1: $pdo->prepare()',
            text: '<p>–ö–æ—Ä—É—Ç–∏–Ω–∞ 1 –≤—ã–∑—ã–≤–∞–µ—Ç <code>prepare()</code>. –ü—É–ª –≤—ã–¥–µ–ª—è–µ—Ç <span class="db-highlight">—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ #1</span> –∏ —Å–æ–∑–¥–∞—ë—Ç statement.</p>' +
                  '<p>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ <span class="pin-highlight">–ø—Ä–∏–≤—è–∑–∞–Ω–æ</span> –∫ –∫–æ—Ä—É—Ç–∏–Ω–µ: <code>$stmt</code> —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç <code>pool_slot_refcount</code>. –ü–æ–∫–∞ <code>$stmt</code> –∂–∏–≤ ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ –≤–µ—Ä–Ω—ë—Ç—Å—è –≤ –ø—É–ª.</p>',
            line: '10', lineState: 'cpu',
            slots: ['c1', 'free'], slotPins: ['$stmt (rc=1)', ''], queue: [],
            cards: ['conn #1', '–≥–æ—Ç–æ–≤–∞', '–≥–æ—Ç–æ–≤–∞'], cardStates: ['running', '', '']
        },
        {
            time: 1,
            title: '–ö–æ—Ä—É—Ç–∏–Ω–∞ 1: execute() -> –∂–¥—ë—Ç –ë–î',
            text: '<p>–í—ã–∑–æ–≤ <code>execute()</code> –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç SELECT –≤ –±–∞–∑—É. –ö–æ—Ä—É—Ç–∏–Ω–∞ <span class="db-highlight">–ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è</span>.</p>' +
                  '<p>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ #1 –æ—Å—Ç–∞—ë—Ç—Å—è –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–º ‚Äî <code>$stmt</code> –≤—Å—ë –µ—â—ë –∂–∏–≤ (refcount=1).</p>',
            line: '11', lineState: 'wait',
            slots: ['c1', 'free'], slotPins: ['$stmt (rc=1)', ''], queue: [],
            cards: ['–∂–¥—ë—Ç –ë–î', '–≥–æ—Ç–æ–≤–∞', '–≥–æ—Ç–æ–≤–∞'], cardStates: ['db-wait', '', '']
        },
        {
            time: 1.5,
            title: '–ö–æ—Ä—É—Ç–∏–Ω–∞ 2: $pdo->prepare()',
            text: '<p>–ö–æ—Ä—É—Ç–∏–Ω–∞ 2 –≤—ã–∑—ã–≤–∞–µ—Ç <code>prepare()</code>. –ü—É–ª –≤—ã–¥–µ–ª—è–µ—Ç <span class="db-highlight">—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ #2</span>.</p>' +
                  '<p>–¢–µ–ø–µ—Ä—å –æ–±–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞–Ω—è—Ç—ã. –ö–∞–∂–¥–æ–µ –ø—Ä–∏–≤—è–∑–∞–Ω–æ —Å–≤–æ–∏–º <code>$stmt</code>.</p>',
            line: '10', lineState: 'cpu',
            slots: ['c1', 'c2'], slotPins: ['$stmt (rc=1)', '$stmt (rc=1)'], queue: [],
            cards: ['–∂–¥—ë—Ç –ë–î', 'conn #2', '–≥–æ—Ç–æ–≤–∞'], cardStates: ['db-wait', 'running', '']
        },
        {
            time: 2,
            title: '–ö–æ—Ä—É—Ç–∏–Ω–∞ 3: prepare() ‚Äî –ø—É–ª –ø—É—Å—Ç!',
            text: '<p>–ö–æ—Ä—É—Ç–∏–Ω–∞ 3 –≤—ã–∑—ã–≤–∞–µ—Ç <code>prepare()</code>, –Ω–æ <span class="pool-highlight">–æ–±–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∑–∞–Ω—è—Ç—ã!</span></p>' +
                  '<p>–ö–æ—Ä—É—Ç–∏–Ω–∞ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ç–æ–∫ ‚Äî –æ–Ω–∞ <span class="highlight">–ø—Ä–∏–æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è</span> –∏ –≤—Å—Ç–∞—ë—Ç –≤ –æ—á–µ—Ä–µ–¥—å. ' +
                  '–ö–∞–∫ —Ç–æ–ª—å–∫–æ –ª—é–±–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Å–≤–æ–±–æ–¥–∏—Ç—Å—è (–∫–æ–≥–¥–∞ <code>$stmt</code> –±—É–¥–µ—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω –∏ –Ω–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏), –∫–æ—Ä—É—Ç–∏–Ω–∞ 3 –ø–æ–ª—É—á–∏—Ç –µ–≥–æ.</p>',
            line: '10', lineState: 'pool-wait',
            slots: ['c1', 'c2'], slotPins: ['$stmt (rc=1)', '$stmt (rc=1)'], queue: ['c3'],
            cards: ['–∂–¥—ë—Ç –ë–î', '–∂–¥—ë—Ç –ë–î', '–∂–¥—ë—Ç –ø—É–ª'], cardStates: ['db-wait', 'db-wait', 'pool-wait']
        },
        {
            time: 12,
            title: '–í—Å–µ –∂–¥—É—Ç',
            text: '<p>–¢—Ä–∏ –∫–æ—Ä—É—Ç–∏–Ω—ã –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. CPU —Å–≤–æ–±–æ–¥–µ–Ω ‚Äî —Ä–µ–∞–∫—Ç–æ—Ä –∂–¥—ë—Ç —Å–æ–±—ã—Ç–∏–π –æ—Ç –ë–î.</p>' +
                  '<p>–°–æ–µ–¥–∏–Ω–µ–Ω–∏—è #1 –∏ #2 –ø—Ä–∏–≤—è–∑–∞–Ω—ã: —É –∫–∞–∂–¥–æ–≥–æ <code>pool_slot_refcount=1</code> –∏–∑-–∑–∞ –∂–∏–≤–æ–≥–æ <code>$stmt</code>. ' +
                  '–ö–æ—Ä—É—Ç–∏–Ω–∞ 3 –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ ‚Äî <code>pdo_pool_maybe_release()</code> –Ω–µ –æ—Ç–ø—É—Å—Ç–∏—Ç –∏—Ö, –ø–æ–∫–∞ refcount –Ω–µ —Å—Ç–∞–Ω–µ—Ç 0.</p>',
            line: '11', lineState: 'wait',
            slots: ['c1', 'c2'], slotPins: ['$stmt (rc=1)', '$stmt (rc=1)'], queue: ['c3'],
            cards: ['–∂–¥—ë—Ç –ë–î', '–∂–¥—ë—Ç –ë–î', '–∂–¥—ë—Ç –ø—É–ª'], cardStates: ['db-wait', 'db-wait', 'pool-wait']
        },
        {
            time: 21,
            title: '–ö–æ—Ä—É—Ç–∏–Ω–∞ 1: –ë–î –æ—Ç–≤–µ—Ç–∏–ª–∞!',
            text: '<p>SELECT –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ –∑–∞ ~20ms. –ö–æ—Ä—É—Ç–∏–Ω–∞ 1 –≤—ã–∑—ã–≤–∞–µ—Ç <code>fetch()</code> –∏ <code>processUser()</code>.</p>' +
                  '<p>–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ #1 –≤—Å—ë –µ—â—ë –ø—Ä–∏–≤—è–∑–∞–Ω–æ ‚Äî <code>$stmt</code> –ø–æ–∫–∞ –∂–∏–≤.</p>',
            line: '14', lineState: 'cpu',
            slots: ['c1', 'c2'], slotPins: ['$stmt (rc=1)', '$stmt (rc=1)'], queue: ['c3'],
            cards: ['–æ–±—Ä–∞–±–æ—Ç–∫–∞', '–∂–¥—ë—Ç –ë–î', '–∂–¥—ë—Ç –ø—É–ª'], cardStates: ['running', 'db-wait', 'pool-wait']
        },
        {
            time: 23,
            title: '$stmt —É–Ω–∏—á—Ç–æ–∂–µ–Ω -> –∞–≤—Ç–æ-release!',
            text: '<p>–ö–æ—Ä—É—Ç–∏–Ω–∞ 1 –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å. <code>$stmt</code> –≤—ã—Ö–æ–¥–∏—Ç –∏–∑ scope ‚Äî –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä: <code>refcount--</code> ‚Üí <code>refcount=0</code>.</p>' +
                  '<p>–í—ã–∑—ã–≤–∞–µ—Ç—Å—è <code>pdo_pool_maybe_release()</code>: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ—Ç, refcount=0 ‚Üí <span class="highlight">—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ #1 –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –ø—É–ª!</span></p>' +
                  '<p>–ö–æ—Ä—É—Ç–∏–Ω–∞ 3 <span class="highlight">–º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç</span> –µ–≥–æ –∏–∑ –æ—á–µ—Ä–µ–¥–∏. –ù–∏–∫–∞–∫–æ–≥–æ —Ä—É—á–Ω–æ–≥–æ <code>release()</code> ‚Äî –≤—Å—ë –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>',
            line: '18', lineState: 'release',
            slots: ['c3', 'c2'], slotPins: ['$stmt (rc=1)', '$stmt (rc=1)'], queue: [],
            cards: ['–∑–∞–≤–µ—Ä—à–µ–Ω–∞', '–∂–¥—ë—Ç –ë–î', 'conn #1'], cardStates: ['done', 'db-wait', 'running']
        },
        {
            time: 24,
            title: '–ö–æ—Ä—É—Ç–∏–Ω–∞ 3: execute()',
            text: '<p>–ö–æ—Ä—É—Ç–∏–Ω–∞ 3 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≤–æ–π –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ #1. –ö–æ—Ä—É—Ç–∏–Ω–∞ 2 –≤—Å—ë –µ—â—ë –∂–¥—ë—Ç.</p>' +
                  '<p>–û–±–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å–Ω–æ–≤–∞ –∑–∞–Ω—è—Ç—ã, –Ω–æ –æ—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞.</p>',
            line: '11', lineState: 'wait',
            slots: ['c3', 'c2'], slotPins: ['$stmt (rc=1)', '$stmt (rc=1)'], queue: [],
            cards: ['–∑–∞–≤–µ—Ä—à–µ–Ω–∞', '–∂–¥—ë—Ç –ë–î', '–∂–¥—ë—Ç –ë–î'], cardStates: ['done', 'db-wait', 'db-wait']
        },
        {
            time: 27,
            title: '–ö–æ—Ä—É—Ç–∏–Ω–∞ 2: –ë–î –æ—Ç–≤–µ—Ç–∏–ª–∞!',
            text: '<p>INSERT –∫–æ—Ä—É—Ç–∏–Ω—ã 2 –∑–∞–≤–µ—Ä—à–∏–ª—Å—è –∑–∞ ~25ms. –û–Ω–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</p>',
            line: '14', lineState: 'cpu',
            slots: ['c3', 'c2'], slotPins: ['$stmt (rc=1)', '$stmt (rc=1)'], queue: [],
            cards: ['–∑–∞–≤–µ—Ä—à–µ–Ω–∞', '–æ–±—Ä–∞–±–æ—Ç–∫–∞', '–∂–¥—ë—Ç –ë–î'], cardStates: ['done', 'running', 'db-wait']
        },
        {
            time: 29,
            title: '–ö–æ—Ä—É—Ç–∏–Ω–∞ 2: $stmt —É–Ω–∏—á—Ç–æ–∂–µ–Ω -> –∞–≤—Ç–æ-release',
            text: '<p>–ö–æ—Ä—É—Ç–∏–Ω–∞ 2 –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å, <code>$stmt</code> —É–Ω–∏—á—Ç–æ–∂–µ–Ω. <code>refcount=0</code>, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –Ω–µ—Ç ‚Üí —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ #2 <span class="highlight">–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è</span> –≤ –ø—É–ª.</p>' +
                  '<p>–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞ ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ –∂–¥—ë—Ç —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è.</p>',
            line: '18', lineState: 'release',
            slots: ['c3', 'free'], slotPins: ['$stmt (rc=1)', ''], queue: [],
            cards: ['–∑–∞–≤–µ—Ä—à–µ–Ω–∞', '–∑–∞–≤–µ—Ä—à–µ–Ω–∞', '–∂–¥—ë—Ç –ë–î'], cardStates: ['done', 'done', 'db-wait']
        },
        {
            time: 44,
            title: '–ö–æ—Ä—É—Ç–∏–Ω–∞ 3: –ë–î –æ—Ç–≤–µ—Ç–∏–ª–∞!',
            text: '<p>–ü–æ—Å–ª–µ–¥–Ω–∏–π –∑–∞–ø—Ä–æ—Å –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ. –ö–æ—Ä—É—Ç–∏–Ω–∞ 3 –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</p>',
            line: '14', lineState: 'cpu',
            slots: ['c3', 'free'], slotPins: ['$stmt (rc=1)', ''], queue: [],
            cards: ['–∑–∞–≤–µ—Ä—à–µ–Ω–∞', '–∑–∞–≤–µ—Ä—à–µ–Ω–∞', '–æ–±—Ä–∞–±–æ—Ç–∫–∞'], cardStates: ['done', 'done', 'running']
        },
        {
            time: 46,
            title: '–ì–æ—Ç–æ–≤–æ!',
            text: '<p>–í—Å–µ —Ç—Ä–∏ –∫–æ—Ä—É—Ç–∏–Ω—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã –∑–∞ <span class="highlight">~46ms</span>. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–Ω—è–ª–æ –±—ã ~69ms. –≠–∫–æ–Ω–æ–º–∏—è <span class="highlight">~33%</span>.</p>' +
                  '<p>–ì–ª–∞–≤–Ω–æ–µ: —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É –Ω–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é —É–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º–∏! PDO –ø—É–ª <span class="highlight">–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</span> –æ—Ç–¥–∞—ë—Ç –∏ –∑–∞–±–∏—Ä–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è ' +
                  '–Ω–∞ –æ—Å–Ω–æ–≤–µ –∂–∏–∑–Ω–µ–Ω–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ <code>$stmt</code> –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.</p>',
            line: '19', lineState: 'cpu',
            slots: ['free', 'free'], slotPins: ['', ''], queue: [],
            cards: ['–∑–∞–≤–µ—Ä—à–µ–Ω–∞', '–∑–∞–≤–µ—Ä—à–µ–Ω–∞', '–∑–∞–≤–µ—Ä—à–µ–Ω–∞'], cardStates: ['done', 'done', 'done']
        }
    ];

    var trackEls = [document.getElementById('track0'), document.getElementById('track1'), document.getElementById('track2')];
    var timeDisplay = document.getElementById('timeDisplay');
    var playBtn = document.getElementById('playBtn'), stepBtn = document.getElementById('stepBtn'), resetBtn = document.getElementById('resetBtn');
    var speedSelect = document.getElementById('speedSelect'), loopCheckbox = document.getElementById('loopCheckbox');
    var totalTimeEl = document.getElementById('totalTime'), dbWaitTimeEl = document.getElementById('dbWaitTime');
    var poolWaitTimeEl = document.getElementById('poolWaitTime'), savedTimeEl = document.getElementById('savedTime');
    var explanationTitle = document.getElementById('explanationTitle'), explanationText = document.getElementById('explanationText');
    var codeBlock = document.getElementById('codeBlock'), codePanel = document.getElementById('codePanel');
    var slot0 = document.getElementById('slot0'), slot1 = document.getElementById('slot1');
    var slotUser0 = document.getElementById('slotUser0'), slotUser1 = document.getElementById('slotUser1');
    var slotIcon0 = document.getElementById('slotIcon0'), slotIcon1 = document.getElementById('slotIcon1');
    var slotPin0 = document.getElementById('slotPin0'), slotPin1 = document.getElementById('slotPin1');
    var queueItems = document.getElementById('queueItems');
    var cardStatus = [document.getElementById('cardStatus0'), document.getElementById('cardStatus1'), document.getElementById('cardStatus2')];

    var isPlaying = false, currentStepIndex = 0, animationId = null;
    var playheads = [];

    var coroNames = ['–ö–æ—Ä—É—Ç–∏–Ω–∞ 1', '–ö–æ—Ä—É—Ç–∏–Ω–∞ 2', '–ö–æ—Ä—É—Ç–∏–Ω–∞ 3'];
    var coroClasses = ['c1', 'c2', 'c3'];

    function createSegments() {
        trackEls.forEach(function(t) { t.innerHTML = ''; });
        timelines.forEach(function(tl, ti) {
            tl.forEach(function(s) { trackEls[ti].appendChild(createSegmentElement(s)); });
            var ph = document.createElement('div');
            ph.className = 'playhead';
            ph.style.left = '0%';
            trackEls[ti].appendChild(ph);
            playheads[ti] = ph;
        });
    }

    function createSegmentElement(seg) {
        var el = document.createElement('div');
        el.className = 'segment ' + seg.type + ' future';
        el.style.left = (seg.start / TOTAL_DURATION) * 100 + '%';
        el.style.width = (seg.duration / TOTAL_DURATION) * 100 + '%';
        var l = document.createElement('div'); l.className = 'segment-label'; l.textContent = seg.label;
        var t = document.createElement('div'); t.className = 'segment-time'; t.textContent = seg.duration + 'ms';
        el.appendChild(l); el.appendChild(t);
        el.dataset.start = seg.start; el.dataset.end = seg.start + seg.duration;
        return el;
    }

    function updateTimeline(time) {
        var pct = (time / TOTAL_DURATION) * 100;
        trackEls.forEach(function(track, ti) {
            track.querySelectorAll('.segment').forEach(function(s) {
                parseFloat(s.dataset.start) <= time ? s.classList.remove('future') : s.classList.add('future');
            });
            var phPct = 0;
            timelines[ti].forEach(function(seg) {
                if (seg.start <= time && seg.start + seg.duration >= time) phPct = pct;
                else if (seg.start + seg.duration <= time) {
                    var segEnd = ((seg.start + seg.duration) / TOTAL_DURATION) * 100;
                    if (segEnd > phPct) phPct = segEnd;
                }
            });
            playheads[ti].style.left = phPct + '%';
        });
        timeDisplay.textContent = Math.round(time) + ' ms';
    }

    function updateCodeHighlight(step) {
        codeBlock.querySelectorAll('.code-line').forEach(function(l) {
            l.classList.remove('active-cpu', 'active-wait', 'active-pool-wait', 'active-release');
        });
        codePanel.classList.remove('active-c1', 'active-c2', 'active-c3');
        if (step.line) {
            var el = codeBlock.querySelector('[data-line="' + step.line + '"]');
            if (el) {
                if (step.lineState === 'cpu') el.classList.add('active-cpu');
                else if (step.lineState === 'wait') el.classList.add('active-wait');
                else if (step.lineState === 'pool-wait') el.classList.add('active-pool-wait');
                else if (step.lineState === 'release') el.classList.add('active-release');
            }
        }
    }

    function updatePool(step) {
        var slotEls = [slot0, slot1];
        var slotUserEls = [slotUser0, slotUser1];
        var slotIconEls = [slotIcon0, slotIcon1];
        var slotPinEls = [slotPin0, slotPin1];
        var slotDisplayNames = { 'free': '—Å–≤–æ–±–æ–¥–Ω–æ', 'c1': '–ö–æ—Ä—É—Ç–∏–Ω–∞ 1', 'c2': '–ö–æ—Ä—É—Ç–∏–Ω–∞ 2', 'c3': '–ö–æ—Ä—É—Ç–∏–Ω–∞ 3' };

        step.slots.forEach(function(state, i) {
            slotEls[i].className = 'pool-slot';
            slotUserEls[i].className = 'slot-user';
            if (state === 'free') {
                slotEls[i].classList.add('free');
                slotUserEls[i].classList.add('free');
                slotIconEls[i].textContent = 'üîå';
            } else {
                slotEls[i].classList.add('in-use-' + state);
                slotUserEls[i].classList.add(state);
                slotIconEls[i].textContent = 'üîó';
            }
            slotUserEls[i].textContent = slotDisplayNames[state];

            // Pin indicator
            slotPinEls[i].textContent = step.slotPins[i] || '';
            slotPinEls[i].className = 'slot-pin';
            if (step.slotPins[i] && step.slotPins[i].indexOf('$stmt') >= 0) slotPinEls[i].classList.add('stmt');
            else if (step.slotPins[i] && step.slotPins[i].indexOf('txn') >= 0) slotPinEls[i].classList.add('txn');
        });

        // Queue
        if (step.queue.length === 0) {
            queueItems.innerHTML = '<span class="queue-empty">–ø—É—Å—Ç–æ</span>';
        } else {
            queueItems.innerHTML = '';
            step.queue.forEach(function(c) {
                var item = document.createElement('span');
                item.className = 'queue-item ' + c;
                item.textContent = coroNames[coroClasses.indexOf(c)];
                queueItems.appendChild(item);
            });
        }

        // Cards
        step.cards.forEach(function(label, i) {
            cardStatus[i].textContent = label;
            cardStatus[i].className = 'coro-card-status';
            if (step.cardStates[i]) cardStatus[i].classList.add(step.cardStates[i]);
        });
    }

    function updateStats(time) {
        totalTimeEl.textContent = Math.round(time) + ' ms';
        var dbW = 0, poolW = 0;
        timelines.forEach(function(tl) {
            tl.forEach(function(s) {
                if (s.start < time) {
                    var d = Math.min(s.start + s.duration, time) - s.start;
                    if (s.type === 'db-wait') dbW += d;
                    else if (s.type === 'pool-wait') poolW += d;
                }
            });
        });
        dbWaitTimeEl.textContent = Math.round(dbW) + ' ms';
        poolWaitTimeEl.textContent = Math.round(poolW) + ' ms';
        savedTimeEl.textContent = Math.round(Math.max(0, 69 - time)) + ' ms';
    }

    function goToStep(i) {
        if (i < 0 || i >= steps.length) return;
        currentStepIndex = i;
        var s = steps[i];
        updateTimeline(s.time);
        updateCodeHighlight(s);
        updatePool(s);
        updateStats(s.time);
        explanationTitle.textContent = s.title;
        explanationText.innerHTML = s.text;
    }

    function nextStep() {
        if (currentStepIndex < steps.length - 1) goToStep(currentStepIndex + 1);
        else if (loopCheckbox.checked && isPlaying) goToStep(0);
        else stopAnimation();
    }

    function animate() {
        if (!isPlaying) return;
        nextStep();
        if (currentStepIndex < steps.length - 1 || loopCheckbox.checked)
            animationId = setTimeout(animate, parseInt(speedSelect.value));
    }

    function startAnimation() {
        if (currentStepIndex >= steps.length - 1 && !loopCheckbox.checked) reset();
        isPlaying = true;
        playBtn.innerHTML = '&#9208; –ü–∞—É–∑–∞';
        stepBtn.disabled = true;
        animationId = setTimeout(animate, parseInt(speedSelect.value));
    }

    function stopAnimation() {
        isPlaying = false;
        playBtn.innerHTML = '&#9654; –ó–∞–ø—É—Å—Ç–∏—Ç—å';
        stepBtn.disabled = false;
        if (animationId) { clearTimeout(animationId); animationId = null; }
    }

    function reset() { stopAnimation(); goToStep(0); }

    playBtn.addEventListener('click', function() { isPlaying ? stopAnimation() : startAnimation(); });
    stepBtn.addEventListener('click', nextStep);
    resetBtn.addEventListener('click', reset);
    speedSelect.addEventListener('change', function() { if (isPlaying) { stopAnimation(); startAnimation(); } });

    createSegments();
    goToStep(0);
})();
</script>
