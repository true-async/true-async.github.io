---
layout: interactive
lang: ru
path_key: "/interactive/learning-map.html"
nav_active: ""
permalink: /ru/interactive/learning-map.html
page_title: "Карта изучения TrueAsync"
description: "Интерактивная карта документации — концепции, функции и путь обучения"
---

<style>
    .interactive-demo .map-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
        align-items: center;
        margin-bottom: 16px;
    }
    .interactive-demo .map-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        justify-content: center;
        align-items: center;
        font-size: 0.82em;
        color: var(--color-text-secondary);
    }
    .interactive-demo .legend-item {
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }
    .interactive-demo .legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 3px;
        display: inline-block;
        flex-shrink: 0;
    }
    .interactive-demo .legend-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: #6B58FF;
        color: #fff;
        font-size: 0.7em;
        font-weight: 700;
        flex-shrink: 0;
    }
    .interactive-demo .map-container {
        position: relative;
        width: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-xl);
        background: var(--color-bg-subtle);
    }
    .interactive-demo .map-container svg {
        display: block;
        width: 100%;
        min-width: 1000px;
        height: auto;
    }
    .interactive-demo .map-scroll-hint {
        display: none;
        text-align: center;
        font-size: 0.8em;
        color: var(--color-text-muted);
        margin-bottom: 8px;
    }
    @media (max-width: 1020px) {
        .interactive-demo .map-scroll-hint { display: block; }
    }

    /* Tooltip */
    .interactive-demo .map-tooltip {
        position: fixed;
        pointer-events: none;
        background: #fff;
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: 10px 14px;
        font-size: 0.82em;
        box-shadow: 0 4px 20px rgba(0,0,0,0.12);
        z-index: 100;
        opacity: 0;
        transition: opacity 0.18s;
        max-width: 320px;
        line-height: 1.45;
    }
    .interactive-demo .map-tooltip.visible { opacity: 1; }
    .interactive-demo .tooltip-title {
        font-weight: 700;
        color: var(--color-text);
        margin-bottom: 2px;
        font-size: 1.05em;
    }
    .interactive-demo .tooltip-desc {
        color: var(--color-text-secondary);
        margin-bottom: 4px;
    }
    .interactive-demo .tooltip-group {
        font-size: 0.88em;
        font-weight: 500;
    }
    .interactive-demo .tooltip-order {
        font-size: 0.85em;
        margin-top: 3px;
        font-weight: 600;
    }
    .interactive-demo .tooltip-sub {
        font-size: 0.85em;
        margin-top: 5px;
        color: var(--color-text-secondary);
        border-top: 1px solid var(--color-border);
        padding-top: 5px;
    }
    .interactive-demo .tooltip-sub a {
        display: block;
        color: var(--color-primary);
        text-decoration: none;
        padding: 1px 0;
    }
    .interactive-demo .tooltip-sub a:hover { text-decoration: underline; }

    .interactive-demo .tooltip-code {
        margin-top: 6px;
        padding: 6px 8px;
        background: #F3F4F6;
        border-radius: 6px;
        font-family: 'Fira Mono', monospace;
        font-size: 0.82em;
        line-height: 1.5;
        color: #1F2937;
        white-space: pre;
        overflow-x: auto;
        border: 1px solid #E5E7EB;
    }
    .interactive-demo .tooltip-code .kw { color: #7C3AED; font-weight: 600; }
    .interactive-demo .tooltip-code .fn { color: #2563EB; }
    .interactive-demo .tooltip-code .str { color: #16A34A; }
    .interactive-demo .tooltip-code .var { color: #0891B2; }
    .interactive-demo .tooltip-code .cm { color: #9CA3AF; font-style: italic; }
    .interactive-demo .tooltip-code .num { color: #EA580C; }

    /* SVG node styles */
    .interactive-demo .node {
        cursor: pointer;
        transition: opacity 0.25s ease;
    }
    .interactive-demo .node.dimmed { opacity: 0.12; }
    .interactive-demo .node .node-bg {
        transition: stroke-width 0.2s ease, filter 0.2s ease;
    }
    .interactive-demo .node.highlighted .node-bg {
        stroke-width: 2.5;
    }
    .interactive-demo .edge {
        transition: opacity 0.25s ease, stroke-width 0.2s ease;
    }
    .interactive-demo .edge.dimmed { opacity: 0.04 !important; }
    .interactive-demo .edge.highlighted {
        opacity: 0.8 !important;
        stroke-width: 2.5 !important;
    }

    /* Badge pop animation */
    @keyframes badgePop {
        0% { transform: scale(0); opacity: 0; }
        60% { transform: scale(1.3); opacity: 1; }
        100% { transform: scale(1); opacity: 1; }
    }
    .interactive-demo .order-badge-g {
        opacity: 0;
        animation: badgePop 0.35s ease forwards;
    }

    /* Edge draw animation */
    @keyframes edgeDraw {
        from { stroke-dashoffset: 800; }
        to { stroke-dashoffset: 0; }
    }
    .interactive-demo .edge-anim {
        stroke-dasharray: 800;
        animation: edgeDraw 1.2s ease forwards;
    }

    /* Group background zones */
    .interactive-demo .group-zone {
        opacity: 0.45;
        transition: opacity 0.3s ease;
    }
    .interactive-demo .group-zone.dimmed { opacity: 0.05; }

    /* Info box */
    .interactive-demo .map-info {
        margin-top: 20px;
        padding: 16px 20px;
        background: var(--color-bg-subtle);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        font-size: 0.88em;
        color: var(--color-text-secondary);
        line-height: 1.6;
    }
    .interactive-demo .map-info strong {
        color: var(--color-text);
    }
</style>

<div class="map-controls">
    <div class="map-legend">
        <span class="legend-item"><span class="legend-dot" style="background:#6B58FF"></span> Асинхронные примитивы</span>
        <span class="legend-item"><span class="legend-dot" style="background:#0891B2"></span> Управление и безопасность</span>
        <span class="legend-item"><span class="legend-dot" style="background:#16A34A"></span> Ресурсы и пулы</span>
        <span class="legend-item"><span class="legend-dot" style="background:#2563EB"></span> Справочник функций</span>
        <span class="legend-item">
            <svg width="28" height="10"><line x1="0" y1="5" x2="28" y2="5" stroke="#6B58FF" stroke-width="2" marker-end="url(#legendArr)"/><defs><marker id="legendArr" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="7" markerHeight="5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#6B58FF"/></marker></defs></svg>
            Зависимость
        </span>
        <span class="legend-item"><span class="legend-badge">2</span> Порядок</span>
    </div>
</div>

<p class="map-scroll-hint">&#8592; Прокрутите для просмотра всей карты &#8594;</p>

<div class="map-container">
    <svg id="learningMap" viewBox="0 0 1260 820" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
        <defs>
            <marker id="arrowPath" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
                <polygon points="0 0,10 3.5,0 7" fill="#6B58FF" opacity="0.65"/>
            </marker>
            <marker id="arrowTeal" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
                <polygon points="0 0,10 3.5,0 7" fill="#0891B2" opacity="0.65"/>
            </marker>
            <marker id="arrowGreen" viewBox="0 0 10 7" refX="10" refY="3.5" markerWidth="8" markerHeight="6" orient="auto-start-reverse">
                <polygon points="0 0,10 3.5,0 7" fill="#16A34A" opacity="0.65"/>
            </marker>
            <filter id="nodeShadow" x="-20%" y="-20%" width="140%" height="140%">
                <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.06"/>
            </filter>
        </defs>
        <!-- Group zone backgrounds -->
        <g id="groupZones"></g>
        <!-- Edges -->
        <g id="edgesGroup"></g>
        <!-- Nodes -->
        <g id="nodesGroup"></g>
    </svg>
</div>

<div class="map-tooltip" id="mapTooltip">
    <div class="tooltip-title" id="tooltipTitle"></div>
    <div class="tooltip-desc" id="tooltipDesc"></div>
    <div class="tooltip-group" id="tooltipGroup"></div>
    <div class="tooltip-order" id="tooltipOrder"></div>
    <div class="tooltip-code" id="tooltipCode"></div>
    <div class="tooltip-sub" id="tooltipSub"></div>
</div>

<div class="map-info">
    <strong>Наведите</strong> на узел, чтобы подсветить его связи.
    <strong>Нажмите</strong>, чтобы перейти к документации.
    Нумерованные значки показывают рекомендованный порядок изучения.
</div>

<script>
(function() {
    /* ===== SEMANTIC GROUPS ===== */
    var GRP = {
        primitives: { color: '#6B58FF', bg: 'rgba(107,88,255,0.06)', border: 'rgba(107,88,255,0.30)', arrow: 'url(#arrowPath)', label: 'Асинхронные примитивы' },
        control:    { color: '#0891B2', bg: 'rgba(8,145,178,0.06)',  border: 'rgba(8,145,178,0.30)',  arrow: 'url(#arrowTeal)',  label: 'Управление и безопасность' },
        resources:  { color: '#16A34A', bg: 'rgba(22,163,74,0.06)',  border: 'rgba(22,163,74,0.30)',  arrow: 'url(#arrowGreen)', label: 'Ресурсы и пулы' },
        reference:  { color: '#2563EB', bg: 'rgba(37,99,235,0.06)',  border: 'rgba(37,99,235,0.30)',  arrow: 'url(#arrowPath)',  label: 'Справочник функций' }
    };

    /* ===== NODES =====
       Each node: id, title (bold), desc (why), url, group, cx, cy, w, h, order
       w/h = balloon size */
    var nodes = [
        /* === Primitives group === */
        { id: 'coroutines', title: 'Корутины',  desc: 'Запускать код асинхронно',
          code: '<span class="var">$coro</span> = <span class="fn">spawn</span>(<span class="kw">function</span>() {\n  <span class="fn">echo</span> <span class="str">"async!"</span>;\n});',
          url: '/ru/docs/concepts/coroutines.html', group: 'primitives', order: 1,
          cx: 440, cy: 100, w: 150, h: 52 },

        { id: 'scope', title: 'Scope', desc: 'Контролировать время жизни корутин',
          code: '<span class="var">$scope</span> = <span class="kw">new</span> Async\\<span class="fn">Scope</span>();\n<span class="fn">spawn</span>(<span class="var">$scope</span>, <span class="var">$task</span>);',
          url: '/ru/docs/concepts/scope.html', group: 'primitives', order: 2,
          cx: 700, cy: 100, w: 140, h: 52 },

        { id: 'future', title: 'Future', desc: 'Получить результат асинхронной операции',
          code: '<span class="var">$future</span> = <span class="fn">spawn</span>(<span class="var">$task</span>);\n<span class="var">$result</span> = <span class="fn">await</span>(<span class="var">$future</span>);',
          url: '/ru/docs/concepts/future.html', group: 'primitives', order: 3,
          cx: 260, cy: 215, w: 140, h: 52 },

        { id: 'channels', title: 'Каналы', desc: 'Передавать данные между корутинами',
          code: '<span class="var">$ch</span> = <span class="kw">new</span> <span class="fn">Channel</span>(<span class="num">10</span>);\n<span class="var">$ch</span>-><span class="fn">send</span>(<span class="str">"data"</span>);\n<span class="var">$val</span> = <span class="var">$ch</span>-><span class="fn">recv</span>();',
          url: '/ru/docs/concepts/channels.html', group: 'primitives', order: 4,
          cx: 510, cy: 215, w: 140, h: 52 },

        { id: 'context', title: 'Context', desc: 'Хранить данные в иерархии скоупов',
          code: '<span class="fn">current_context</span>()-><span class="fn">set</span>(<span class="str">\'key\'</span>, <span class="str">\'val\'</span>);\n<span class="var">$v</span> = <span class="fn">current_context</span>()-><span class="fn">find</span>(<span class="str">\'key\'</span>);',
          url: '/ru/docs/concepts/context.html', group: 'primitives', order: 5,
          cx: 920, cy: 215, w: 140, h: 52 },

        /* === Control group === */
        { id: 'cancellation', title: 'Отмена', desc: 'Прерывать корутины безопасно',
          code: '<span class="var">$coro</span>-><span class="fn">cancel</span>();\n<span class="cm">// or with timeout:</span>\n<span class="fn">await</span>(<span class="var">$coro</span>, <span class="fn">timeout</span>(<span class="num">5000</span>));',
          url: '/ru/docs/concepts/cancellation.html', group: 'control', order: 6,
          cx: 700, cy: 370, w: 140, h: 52 },

        { id: 'exceptions', title: 'Исключения', desc: 'Обрабатывать ошибки в асинхронном коде',
          code: '<span class="kw">try</span> { <span class="fn">await</span>(<span class="var">$coro</span>); }\n<span class="kw">catch</span> (<span class="fn">CancellationError</span> <span class="var">$e</span>) {}',
          url: '/ru/docs/concepts/exceptions.html', group: 'control', order: 7,
          cx: 940, cy: 370, w: 148, h: 52 },

        { id: 'interfaces', title: 'Интерфейсы', desc: 'Типы и контракты для расширения',
          code: '<span class="kw">interface</span> <span class="fn">Awaitable</span> {}\n<span class="kw">interface</span> <span class="fn">Completable</span> {}',
          url: '/ru/docs/concepts/interfaces.html', group: 'control', order: 8,
          cx: 820, cy: 480, w: 144, h: 52 },

        /* === Resources group === */
        { id: 'pool', title: 'Async\\Pool', desc: 'Переиспользовать дорогие ресурсы',
          code: '<span class="var">$pool</span> = <span class="kw">new</span> <span class="fn">Pool</span>(\n  <span class="fn">factory</span>: <span class="kw">fn</span>() => <span class="kw">new</span> <span class="fn">Conn</span>(),\n  <span class="fn">max</span>: <span class="num">10</span>\n);',
          url: '/ru/docs/concepts/pool.html', group: 'resources', order: 9,
          cx: 490, cy: 480, w: 150, h: 52 },

        { id: 'pdo-pool', title: 'PDO Pool', desc: 'Пул соединений с базой данных',
          code: '<span class="var">$pdo</span> = <span class="kw">new</span> <span class="fn">PDO</span>(<span class="var">$dsn</span>, <span class="var">$user</span>, <span class="var">$pwd</span>, [\n  PDO::<span class="fn">ATTR_POOL_MAX</span> => <span class="num">10</span>\n]);',
          url: '/ru/docs/concepts/pdo-pool.html', group: 'resources', order: 10,
          cx: 490, cy: 590, w: 140, h: 52 },

        /* === Reference functions === */
        { id: 'ref-spawn', title: 'spawn / await', desc: 'Создание и ожидание корутин',
          code: '<span class="var">$c</span> = <span class="fn">spawn</span>(<span class="fn">fetchUser</span>(...), <span class="num">123</span>);\n<span class="var">$user</span> = <span class="fn">await</span>(<span class="var">$c</span>);',
          url: '/ru/docs/reference/spawn.html', group: 'reference', order: null,
          cx: 160, cy: 100, w: 146, h: 48 },

        { id: 'ref-await', title: 'Функции ожидания', desc: 'await_all, await_any, await_first_success...',
          code: '<span class="var">$results</span> = <span class="fn">await_all</span>(<span class="var">$tasks</span>);\n<span class="var">$first</span> = <span class="fn">await_first_success</span>(<span class="var">$tasks</span>);',
          url: '/ru/docs/reference/supported-functions.html', group: 'reference', order: null,
          cx: 100, cy: 310, w: 170, h: 48 },

        { id: 'ref-control', title: 'delay / suspend', desc: 'Пауза и передача управления',
          code: '<span class="fn">delay</span>(<span class="num">1000</span>); <span class="cm">// 1 сек</span>\n<span class="fn">suspend</span>();  <span class="cm">// yield</span>',
          url: '/ru/docs/reference/delay.html', group: 'reference', order: null,
          cx: 140, cy: 430, w: 152, h: 48 },

        { id: 'ref-cancel', title: 'protect / timeout', desc: 'Защита от отмены и таймауты',
          code: '<span class="fn">protect</span>(<span class="kw">function</span>() {\n  <span class="var">$db</span>-><span class="fn">commit</span>();\n});',
          url: '/ru/docs/reference/protect.html', group: 'reference', order: null,
          cx: 400, cy: 370, w: 160, h: 48 },

        { id: 'ref-info', title: 'Информация', desc: 'get_coroutines, graceful_shutdown...',
          code: '<span class="var">$all</span> = <span class="fn">get_coroutines</span>();\n<span class="fn">graceful_shutdown</span>();',
          url: '/ru/docs/reference/get-coroutines.html', group: 'reference', order: null,
          cx: 1100, cy: 100, w: 134, h: 48 }
    ];

    /* ===== EDGES ===== */
    var edges = [
        /* Core learning path */
        { from: 'coroutines', to: 'scope',         type: 'path' },
        { from: 'coroutines', to: 'future',        type: 'path' },
        { from: 'coroutines', to: 'channels',      type: 'path' },
        { from: 'scope',      to: 'context',       type: 'path' },
        { from: 'scope',      to: 'cancellation',  type: 'path' },
        { from: 'coroutines', to: 'cancellation',  type: 'path' },
        { from: 'cancellation', to: 'exceptions',  type: 'path' },
        { from: 'cancellation', to: 'interfaces',  type: 'path' },
        { from: 'scope',      to: 'pool',          type: 'path' },
        { from: 'channels',   to: 'pool',          type: 'related' },
        { from: 'pool',       to: 'pdo-pool',      type: 'path' },

        /* Reference connections */
        { from: 'coroutines',   to: 'ref-spawn',   type: 'related' },
        { from: 'ref-spawn',    to: 'ref-await',   type: 'related' },
        { from: 'coroutines',   to: 'ref-control', type: 'related' },
        { from: 'cancellation', to: 'ref-cancel',  type: 'related' },
        { from: 'scope',        to: 'ref-info',    type: 'related' }
    ];

    /* ===== SUB-PAGES for clusters ===== */
    var subPages = {
        'ref-spawn': [
            { label: 'spawn()',      url: '/ru/docs/reference/spawn.html' },
            { label: 'spawn_with()', url: '/ru/docs/reference/spawn-with.html' },
            { label: 'await()',      url: '/ru/docs/reference/await.html' }
        ],
        'ref-await': [
            { label: 'await_all()',           url: '/ru/docs/reference/await-all.html' },
            { label: 'await_all_or_fail()',   url: '/ru/docs/reference/await-all-or-fail.html' },
            { label: 'await_any_or_fail()',   url: '/ru/docs/reference/await-any-or-fail.html' },
            { label: 'await_first_success()', url: '/ru/docs/reference/await-first-success.html' },
            { label: 'await_any_of()',        url: '/ru/docs/reference/await-any-of.html' },
            { label: 'Все функции...',         url: '/ru/docs/reference/supported-functions.html' }
        ],
        'ref-control': [
            { label: 'suspend()', url: '/ru/docs/reference/suspend.html' },
            { label: 'delay()',   url: '/ru/docs/reference/delay.html' }
        ],
        'ref-cancel': [
            { label: 'protect()', url: '/ru/docs/reference/protect.html' },
            { label: 'timeout()', url: '/ru/docs/reference/timeout.html' }
        ],
        'ref-info': [
            { label: 'get_coroutines()',    url: '/ru/docs/reference/get-coroutines.html' },
            { label: 'current_coroutine()', url: '/ru/docs/reference/current-coroutine.html' },
            { label: 'current_context()',   url: '/ru/docs/reference/current-context.html' },
            { label: 'coroutine_context()', url: '/ru/docs/reference/coroutine-context.html' },
            { label: 'root_context()',      url: '/ru/docs/reference/root-context.html' },
            { label: 'graceful_shutdown()', url: '/ru/docs/reference/graceful-shutdown.html' }
        ]
    };

    /* ===== GROUP ZONE DEFINITIONS (rounded bg areas) ===== */
    var groupZones = [
        { group: 'primitives', label: 'Асинхронные примитивы', x: 200, y: 48, w: 890, h: 240, rx: 18 },
        { group: 'control',    label: 'Управление и безопасность', x: 595, y: 320, w: 420, h: 235, rx: 18 },
        { group: 'resources',  label: 'Ресурсы и пулы', x: 370, y: 430, w: 210, h: 235, rx: 18 },
        { group: 'reference',  label: 'Справочник функций', x: 40, y: 55, w: 270, h: 445, rx: 18 }
    ];

    /* ===== STATE ===== */
    var NS = 'http://www.w3.org/2000/svg';
    var svgEl = document.getElementById('learningMap');
    var tooltipEl = document.getElementById('mapTooltip');
    var edgesGroup = document.getElementById('edgesGroup');
    var nodesGroup = document.getElementById('nodesGroup');
    var zonesGroup = document.getElementById('groupZones');

    var nodeMap = {};
    var nodeEls = {};
    var edgeEls = [];
    var zoneEls = {};
    var adj = {};
    var hoveredId = null;

    /* ===== BUILD ===== */
    function init() {
        nodes.forEach(function(n) { nodeMap[n.id] = n; adj[n.id] = new Set(); });
        edges.forEach(function(e) { adj[e.from].add(e.to); adj[e.to].add(e.from); });
        renderZones();
        renderEdges();
        renderNodes();
    }

    /* ===== RENDER GROUP ZONES ===== */
    function renderZones() {
        groupZones.forEach(function(z) {
            var grp = GRP[z.group];
            var g = document.createElementNS(NS, 'g');
            g.classList.add('group-zone');
            g.dataset.group = z.group;

            var rect = document.createElementNS(NS, 'rect');
            rect.setAttribute('x', z.x);
            rect.setAttribute('y', z.y);
            rect.setAttribute('width', z.w);
            rect.setAttribute('height', z.h);
            rect.setAttribute('rx', z.rx);
            rect.setAttribute('fill', grp.bg);
            rect.setAttribute('stroke', grp.border);
            rect.setAttribute('stroke-width', '1');
            rect.setAttribute('stroke-dasharray', '6 3');
            g.appendChild(rect);

            /* Zone label in top-left */
            var lbl = document.createElementNS(NS, 'text');
            lbl.setAttribute('x', z.x + 14);
            lbl.setAttribute('y', z.y + 18);
            lbl.setAttribute('font-family', 'Fira Sans, sans-serif');
            lbl.setAttribute('font-size', '11');
            lbl.setAttribute('font-weight', '600');
            lbl.setAttribute('fill', grp.color);
            lbl.setAttribute('opacity', '0.6');
            lbl.textContent = z.label;
            g.appendChild(lbl);

            zonesGroup.appendChild(g);
            zoneEls[z.group] = g;
        });
    }

    /* ===== RENDER EDGES ===== */
    function calcPath(from, to) {
        /* Connect from edge of balloon to edge of target balloon */
        var dx = to.cx - from.cx, dy = to.cy - from.cy;
        var dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < 1) return null;

        /* Find exit/entry points on rounded rects */
        var angle = Math.atan2(dy, dx);
        var s = exitPoint(from, angle);
        var e = exitPoint(to, angle + Math.PI);

        /* Bezier curvature */
        var mx = (s.x + e.x) / 2, my = (s.y + e.y) / 2;
        var ux = dx / dist, uy = dy / dist;
        var off = Math.min(dist * 0.12, 30);
        var px = -uy * off, py = ux * off;
        return 'M' + s.x + ',' + s.y + ' Q' + (mx + px) + ',' + (my + py) + ' ' + e.x + ',' + e.y;
    }

    function exitPoint(n, angle) {
        /* Approximate: find intersection of ray from center with rounded rect */
        var hw = n.w / 2, hh = n.h / 2;
        var cos = Math.cos(angle), sin = Math.sin(angle);
        var tx = cos !== 0 ? hw / Math.abs(cos) : 9999;
        var ty = sin !== 0 ? hh / Math.abs(sin) : 9999;
        var t = Math.min(tx, ty);
        return { x: n.cx + cos * t, y: n.cy + sin * t };
    }

    function renderEdges() {
        edges.forEach(function(e, i) {
            var from = nodeMap[e.from], to = nodeMap[e.to];
            var d = calcPath(from, to);
            if (!d) return;

            var grp = GRP[from.group];
            var path = document.createElementNS(NS, 'path');
            path.setAttribute('d', d);
            path.setAttribute('fill', 'none');

            if (e.type === 'path') {
                path.setAttribute('stroke', grp.color);
                path.setAttribute('stroke-width', '2');
                path.setAttribute('opacity', '0.4');
                /* Pick arrow color matching source group */
                var arrowId = e.from.indexOf('ref-') === 0 ? 'arrowPath' :
                              from.group === 'control' ? 'arrowTeal' :
                              from.group === 'resources' ? 'arrowGreen' : 'arrowPath';
                path.setAttribute('marker-end', 'url(#' + arrowId + ')');
                path.classList.add('edge', 'edge-path', 'edge-anim');
                path.style.animationDelay = (i * 0.05) + 's';
            } else {
                path.setAttribute('stroke', '#94A3B8');
                path.setAttribute('stroke-width', '1.5');
                path.setAttribute('stroke-dasharray', '5 4');
                path.setAttribute('opacity', '0.25');
                path.classList.add('edge', 'edge-related');
            }
            path.dataset.from = e.from;
            path.dataset.to = e.to;
            edgesGroup.appendChild(path);
            edgeEls.push({ el: path, from: e.from, to: e.to, type: e.type });
        });
    }

    /* ===== RENDER NODES (BALLOONS) ===== */
    function renderNodes() {
        nodes.forEach(function(n) {
            var g = document.createElementNS(NS, 'g');
            g.classList.add('node');
            g.dataset.id = n.id;
            g.dataset.group = n.group;

            var grp = GRP[n.group];
            var hw = n.w / 2, hh = n.h / 2;
            var rx = Math.min(hh, 16);

            /* Balloon rect */
            var rect = document.createElementNS(NS, 'rect');
            rect.setAttribute('x', n.cx - hw);
            rect.setAttribute('y', n.cy - hh);
            rect.setAttribute('width', n.w);
            rect.setAttribute('height', n.h);
            rect.setAttribute('rx', rx);
            rect.setAttribute('fill', '#fff');
            rect.setAttribute('stroke', grp.border);
            rect.setAttribute('stroke-width', '1.5');
            rect.setAttribute('filter', 'url(#nodeShadow)');
            rect.classList.add('node-bg');
            g.appendChild(rect);

            /* Left color accent bar */
            var bar = document.createElementNS(NS, 'rect');
            bar.setAttribute('x', n.cx - hw);
            bar.setAttribute('y', n.cy - hh);
            bar.setAttribute('width', 4);
            bar.setAttribute('height', n.h);
            bar.setAttribute('rx', 2);
            bar.setAttribute('fill', grp.color);
            bar.setAttribute('opacity', '0.7');
            /* Clip to rounded corners */
            var clip = document.createElementNS(NS, 'clipPath');
            var clipId = 'clip-' + n.id;
            clip.id = clipId;
            var clipRect = document.createElementNS(NS, 'rect');
            clipRect.setAttribute('x', n.cx - hw);
            clipRect.setAttribute('y', n.cy - hh);
            clipRect.setAttribute('width', n.w);
            clipRect.setAttribute('height', n.h);
            clipRect.setAttribute('rx', rx);
            clip.appendChild(clipRect);
            g.appendChild(clip);
            bar.setAttribute('clip-path', 'url(#' + clipId + ')');
            g.appendChild(bar);

            /* Title text */
            var titleY = n.desc ? n.cy - 6 : n.cy;
            var title = makeText(n.cx + 2, titleY, 12.5, grp.color, n.title, '600');
            g.appendChild(title);

            /* Description text */
            if (n.desc) {
                var desc = makeText(n.cx + 2, n.cy + 10, 10, '#6B7280', n.desc, '400');
                g.appendChild(desc);
            }

            /* Order badge */
            if (n.order !== null && n.order > 0) {
                var bx = n.cx + hw - 2;
                var by = n.cy - hh - 2;

                var bg = document.createElementNS(NS, 'g');
                bg.classList.add('order-badge-g');
                bg.style.animationDelay = (n.order * 0.08) + 's';
                bg.style.transformOrigin = bx + 'px ' + by + 'px';

                var bc = document.createElementNS(NS, 'circle');
                bc.setAttribute('cx', bx);
                bc.setAttribute('cy', by);
                bc.setAttribute('r', 11);
                bc.setAttribute('fill', grp.color);
                bg.appendChild(bc);

                var bt = document.createElementNS(NS, 'text');
                bt.setAttribute('x', bx);
                bt.setAttribute('y', by);
                bt.setAttribute('text-anchor', 'middle');
                bt.setAttribute('dominant-baseline', 'central');
                bt.setAttribute('font-family', 'Fira Sans, sans-serif');
                bt.setAttribute('font-size', '9');
                bt.setAttribute('font-weight', '700');
                bt.setAttribute('fill', '#fff');
                bt.setAttribute('pointer-events', 'none');
                bt.textContent = n.order;
                bg.appendChild(bt);

                g.appendChild(bg);
            }

            /* Events */
            g.addEventListener('mouseenter', function(ev) { onEnter(n.id, ev); });
            g.addEventListener('mouseleave', function() { onLeave(); });
            g.addEventListener('click', function() { onClick(n.id); });

            nodesGroup.appendChild(g);
            nodeEls[n.id] = g;
        });
    }

    function makeText(x, y, fs, fill, content, fw) {
        var t = document.createElementNS(NS, 'text');
        t.setAttribute('x', x);
        t.setAttribute('y', y);
        t.setAttribute('text-anchor', 'middle');
        t.setAttribute('dominant-baseline', 'central');
        t.setAttribute('font-family', 'Fira Sans, sans-serif');
        t.setAttribute('font-size', fs);
        t.setAttribute('font-weight', fw || '400');
        t.setAttribute('fill', fill);
        t.setAttribute('pointer-events', 'none');
        t.textContent = content;
        return t;
    }

    /* ===== INTERACTIONS ===== */
    function onEnter(id, ev) {
        hoveredId = id;
        var neighbors = adj[id] || new Set();
        var hoverNode = nodeMap[id];
        var activeGroups = new Set();
        activeGroups.add(hoverNode.group);

        Object.keys(nodeEls).forEach(function(nid) {
            var el = nodeEls[nid];
            if (nid === id || neighbors.has(nid)) {
                el.classList.remove('dimmed');
                el.classList.add('highlighted');
                activeGroups.add(nodeMap[nid].group);
            } else {
                el.classList.add('dimmed');
                el.classList.remove('highlighted');
            }
        });

        edgeEls.forEach(function(e) {
            if (e.from === id || e.to === id) {
                e.el.classList.remove('dimmed');
                e.el.classList.add('highlighted');
            } else {
                e.el.classList.add('dimmed');
                e.el.classList.remove('highlighted');
            }
        });

        /* Dim non-active group zones */
        Object.keys(zoneEls).forEach(function(gid) {
            if (activeGroups.has(gid)) {
                zoneEls[gid].classList.remove('dimmed');
            } else {
                zoneEls[gid].classList.add('dimmed');
            }
        });

        showTooltip(id, ev);
    }

    function onLeave() {
        hoveredId = null;
        Object.keys(nodeEls).forEach(function(nid) {
            nodeEls[nid].classList.remove('dimmed', 'highlighted');
        });
        edgeEls.forEach(function(e) {
            e.el.classList.remove('dimmed', 'highlighted');
        });
        Object.keys(zoneEls).forEach(function(gid) {
            zoneEls[gid].classList.remove('dimmed');
        });
        hideTooltip();
    }

    function onClick(id) {
        var n = nodeMap[id];
        if (n && n.url) window.location.href = n.url;
    }

    /* ===== TOOLTIP ===== */
    function showTooltip(id, ev) {
        var n = nodeMap[id];
        if (!n) return;
        var grp = GRP[n.group];

        document.getElementById('tooltipTitle').textContent = n.title;
        document.getElementById('tooltipDesc').textContent = n.desc || '';

        var groupEl = document.getElementById('tooltipGroup');
        groupEl.textContent = grp.label;
        groupEl.style.color = grp.color;

        var orderEl = document.getElementById('tooltipOrder');
        if (n.order !== null && n.order > 0) {
            orderEl.textContent = 'Шаг ' + n.order + ' из 10';
            orderEl.style.color = grp.color;
            orderEl.style.display = '';
        } else {
            orderEl.style.display = 'none';
        }

        var codeEl = document.getElementById('tooltipCode');
        if (n.code) {
            codeEl.innerHTML = n.code;
            codeEl.style.display = '';
        } else {
            codeEl.style.display = 'none';
        }

        var subEl = document.getElementById('tooltipSub');
        if (subPages[id]) {
            var html = '';
            subPages[id].forEach(function(p) {
                html += '<a href="' + p.url + '">' + p.label + '</a>';
            });
            subEl.innerHTML = html;
            subEl.style.display = '';
            tooltipEl.style.pointerEvents = 'auto';
        } else {
            subEl.innerHTML = '';
            subEl.style.display = 'none';
            tooltipEl.style.pointerEvents = 'none';
        }

        positionTooltip(ev);
        tooltipEl.classList.add('visible');
    }

    function positionTooltip(ev) {
        var x = ev.clientX + 16;
        var y = ev.clientY + 16;
        var tw = tooltipEl.offsetWidth || 200;
        var th = tooltipEl.offsetHeight || 80;
        if (x + tw > window.innerWidth - 10) x = ev.clientX - tw - 12;
        if (y + th > window.innerHeight - 10) y = ev.clientY - th - 12;
        tooltipEl.style.left = x + 'px';
        tooltipEl.style.top = y + 'px';
    }

    function hideTooltip() {
        tooltipEl.classList.remove('visible');
        tooltipEl.style.pointerEvents = 'none';
    }

    svgEl.addEventListener('mousemove', function(ev) {
        if (hoveredId) positionTooltip(ev);
    });

    /* ===== TOUCH SUPPORT ===== */
    if ('ontouchstart' in window) {
        svgEl.addEventListener('touchstart', function(ev) {
            var target = ev.target.closest('.node');
            if (target) {
                var id = target.dataset.id;
                if (hoveredId === id) {
                    onClick(id);
                } else {
                    onEnter(id, { clientX: ev.touches[0].clientX, clientY: ev.touches[0].clientY });
                    ev.preventDefault();
                }
            } else {
                onLeave();
            }
        }, { passive: false });
    }

    /* ===== INIT ===== */
    init();
})();
</script>
