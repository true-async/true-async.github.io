@startuml

title PDO Pool — Компоненты

package "Пользовательский код" #E8F5E9 {
    class "PDO объект" as UserPDO {
        query()
        exec()
        prepare()
        beginTransaction()
        commit()
        rollBack()
        getPool()
    }
}

package "Ядро PDO (php-src)" #E3F2FD {
    class "pdo_dbh_t\n(template)" as Template {
        driver : pdo_driver_t*
        data_source : char*
        username : char*
        password : char*
        --
        pool : zend_async_pool_t*
        pool_connections : HashTable*
    }

    class "pdo_pool.c" as PoolLogic {
        pdo_pool_create()
        pdo_pool_acquire_conn()
        pdo_pool_maybe_release()
        pdo_pool_peek_conn()
        pdo_pool_destroy()
        --
        pdo_pool_factory()
        pdo_pool_destructor()
        pdo_pool_healthcheck()
        pdo_pool_before_release()
    }
}

package "Async Extension" #FFF3E0 {
    class "zend_async_pool_t" as AsyncPool {
        min_size : uint32_t
        max_size : uint32_t
        user_data : void*
        --
        acquire()
        release()
        close()
    }
}

package "Пул соединений" #FCE4EC {
    class "pdo_dbh_t\n(conn #1)" as Conn1 {
        driver_data : void*
        methods : pdo_dbh_methods*
        in_txn : bool
    }
    class "pdo_dbh_t\n(conn #2)" as Conn2 {
        driver_data : void*
        methods : pdo_dbh_methods*
        in_txn : bool
    }
    class "pdo_dbh_t\n(conn #N)" as ConnN {
        driver_data : void*
        methods : pdo_dbh_methods*
        in_txn : bool
    }
}

package "Корутины" #F3E5F5 {
    class "Корутина A" as CoroA
    class "Корутина B" as CoroB
}

UserPDO --> Template : inner
Template --> AsyncPool : pool
Template --> PoolLogic : управляет
AsyncPool --> Conn1 : хранит
AsyncPool --> Conn2 : хранит
AsyncPool --> ConnN : хранит
PoolLogic --> AsyncPool : acquire / release

CoroA ..> Conn1 : "привязана"
CoroB ..> Conn2 : "привязана"

note right of Template
    Template НЕ подключается к БД.
    Хранит credentials и настройки
    для создания реальных соединений.
end note

note bottom of PoolLogic
    pool_connections: HashTable
    ключ = coroutine ID
    значение = pdo_dbh_t*
end note
@enduml
